<#include "../include/header.html">
<script src="${base.contextPath}/common/code?resourceTypeData=SYS.FRUIT_COLOR" type="text/javascript"></script>
<body>
<div id="batchDiv" style="display: none"></div>
<!--toolbar-->
<div id="page-content">
<div class="panel form-horizontal" id="queryForm">
    <div class="panel-body">
        <div class="col-sm-10">
            <div class="form-group">
                <label class="control-label col-sm-4">名称</label>
                <div class="col-sm-6"><input type="text" class="k-textbox" data-bind="value:model.name"
                                             style="width:100%"></div>
            </div>
            <div class="form-group">
                <label class="control-label col-sm-4">价格</label>
                <div class="col-sm-6"><input type="text" class="k-textbox" data-bind="value:model.price"
                                             style="width:100%"></div>
            </div>

            <div class="form-group">
                <label class="control-label col-sm-4">LOV</label>
                <div class="col-sm-6"><input type="text" id="myName" data-bind="value:model.id,text:model.name"></div>
            </div>

            <div class="form-group">
               <label class="control-label col-sm-4">三级联动</label>
                <div class="col-sm-3"><select id="first" data-bind="value:model.regionId"  ></select></div>
                <div class="col-sm-3"><select id="second" ></select></div>
                <div class="col-sm-2"><select id="third" ></select></div>
            </div>

        </div>
    </div>
    <div class="panel-footer text-right">
        <button class="btn btn-primary" data-bind="click:query">查询</button>
    </div>
</div>

    <div id = "toolbar-btn">
           <span class="btn btn-primary k-grid-add" data-bind="click:createFunction">
    <@spring.message "hap.new"/></span>
        <span class="btn btn-success k-grid-save-changes"
              data-bind="click:saveFunction"><@spring.message "hap.save"/></span>
        <span id = "deleteBtn" onclick="deleteData()" class="btn btn-danger"><@spring.message
        "hap.delete"/></span>
        <span class="btn btn-primary" style="float:left;margin-right:5px;"
              data-bind="click:exportExcelFunction"><@spring.message "hap.exportexcel"/></span>
    </div>

<div id="grid">
</div>
</div>

<!-- 编辑 -->
<div id="dialog">


<script>
        $("#myName").kendoLov(${lovProvider.getLov(base.contextPath, base.locale,
"LOV_DEMO")})
</script>

<script>
    var viewModel = new kendo.observable({
        model: {},
        query: function () {
            $('#grid').data('kendoGrid').dataSource.page(1);
        },createFunction: function(){
            //$('#grid').data('kendoGrid').addRow();
            editData();
        },
        saveFunction: function(){
            $('#grid').data('kendoGrid').saveChanges();
        },
        exportExcelFunction: function (e) {
            var exportConfig = {};
            var columns = [];
            var index = 0;
            for (var i = 0; i < grid.columns.length; i++) {
                if (grid.columns[i].field != null) {
                    var columnInfo = {};
                    columnInfo["name"] = grid.columns[i].field;
                    columnInfo["title"] = grid.columns[i].title;
                    columnInfo["width"] = grid.columns[i].width;
                    var align = $('tbody').find('tr')[0].getElementsByTagName('td')[i].style.textAlign;
                    if (align != null || align != '') {
                        columnInfo["align"] = align;
                    }
                    if (dataSource.options.schema.model.fields[grid.columns[i].field] != null) {
                        columnInfo["type"] = dataSource.options.schema.model.fields[grid.columns[i].field].type;
                    }
                    columns[index] = columnInfo;
                    index++;
                }
            }
            exportConfig["columnsInfo"] = columns;

            exportConfig["param"] = Hap.prepareQueryParameter(viewModel.model.toJSON());
            exportConfig["fileName"] = "demo";
            var $inputImg = $('<input>').attr({name: "config", value: kendo.stringify(exportConfig)});
            var $inputToken=$('<input>').attr({name:"${_csrf.parameterName}",value:"${_csrf.token}",type:"hidden"});
            //   var $inputSubmitBtn=$('<input>').attr({type:"submit",value:"submit"});
            var $form = $("<form>");
            $form.attr({
                target: '_self',
                method: 'post',
                action: '${base.contextPath}/demo/fruit/export'
            }).append($inputImg);
            $form.append($inputToken);
            //$form.append($inputSubmitBtn);
            $form.id='smbForm';
            $("#batchDiv").empty().append($form);//添加到隐藏div中 //如果注释掉title会有乱码
            $($form).submit();
            $("#batchDiv").empty();
        }


    });

    //新建时调用的界面
    window.editData = function(){
        var url = 'fruit_detial.html';

        var dialog =  $("#dialog").kendoWindow({
            actions: [ "Maximize", "Minimize", "Close"],
            width: 900,
            height: 500,
            title: '<@spring.message "hap.edit"/>',
            content: url,
            iframe:  true,
            visible: false,
            modal:true,
            close: function() {
                //window 关闭  刷新 本页面的  grid
                $('#grid').data('kendoGrid').dataSource.page(1);
            }
        }).data("kendoWindow");
        dialog.center().open();
    };

    //编辑弹窗函数
    editFunctionResources = function (id) {
        var dialog = $("#dialog").kendoWindow({
            actions: ["Close"],
            width  : 900,
            height : 500,
            title  : '<@spring.message "hap.edit"/>',
            visible: false,
            iframe : true,
            modal  : true,
            content: 'fruit_detial.html?id=' + id,
            close:function(e){
                $("#grid").data("kendoGrid").dataSource.page(1);
            }
        }).data("kendoWindow");
        dialog.center().open();
    };

    kendo.bind($("#page-content"), viewModel);
    kendo.bind($('#toolbar-btn'), viewModel);

</script>


<script>
    var crudServiceBaseUrl = '${base.contextPath}' ;
    var dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: crudServiceBaseUrl + "/demo/fruit/query",
                    type: "POST",
                    dataType: "json"
                },
                create: {
                    url: crudServiceBaseUrl + "/demo/fruit/submit",
                    contentType: "application/json",
                    type: "POST"
                },
                update: {
                    url: crudServiceBaseUrl + "/demo/fruit/update",
                    contentType: "application/json",
                    type: "POST"
                },
                destroy: {
                    url: crudServiceBaseUrl + "/demo/fruit/delete",
                    contentType: "application/json",
                    type: "POST"
                },
                parameterMap: function (options, type) {
                    if (type !== "read" && options.models) {
                        var datas = Hap.prepareSubmitParameter(options, type);
                        return kendo.stringify(datas);
                    } else if (type === "read") {
                        return Hap.prepareQueryParameter(viewModel.model.toJSON(), options);
                    }
                }
            },
            batch: true,
            serverPaging: true,
            serverSorting: true,
            pageSize: 10,
            schema: {
                data: 'rows',
                total: 'total',
                model: {
                    id: "id",
                    fields: {
                        name: {type:"string"},
                        price: {type:"int"},
                        producingArea: {type:"string"},
                        color: {defaultValue:"red"},
                        regionId: {type:"int"},
                        regionName: {type:"string",editable:false},
                        activeDate: {type:"date"}
                    }
                }
            }
        }
    );
    var grid = $("#grid").kendoGrid({
        dataSource: dataSource,
        navigatable: false,
        height: '100%',
        resizable: true,
        scrollable: true,
        selectable: 'multiple, rowbox',
        pageable: {
            //可以选择一个页面多少条数据
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [{
            field : "name",
            title : "水果名称"
        }, {
            field : "price",
            title : '价格'
        }, {
            field : "producingArea",
            title : "产地"
        },{
            field : "color",
            title : "水果颜色",
            template: function(dataItem){
                var v = dataItem.color;
                $.each(resourceTypeData,function(i,n){
                    if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                        v = n.meaning;
                        return v;
                    }
                })
                return v;
            },
            editor: function(container, options){
                $('<input name="' + options.field + '"/>')
                    .appendTo(container)
                    .kendoDropDownList({
                        dataTextField: "meaning",
                        dataValueField: "value",
                        valuePrimitive: true,
                        dataSource: resourceTypeData
                    });
            }
        },{
            field : "regionName",
            title : "地点"
        },{
            field : "activeDate",
            title : "保质期到",
            format: "{0:yyyy-MM-dd}",
            attributes: {style: "text-align:center"},
            headerAttributes: {
                "class": "table-header-cell",
                style  : "text-align: center"
            }
        },
        {	//编辑
            title: '<@spring.message "hap.edit"/>',
            width: 50,
            template: function (rowdata) {
                if (!!rowdata.id) {
                    return '<a href="javascript:void(0);" onclick="editFunctionResources('+rowdata.id +')"><@spring.message "hap.edit"/></a>'
                }
                return '';
            },
            attributes: {style: "text-align:center"},
            headerAttributes: { style: "text-align:center"}
        }

        ],
        editable: true
    }).data("kendoGrid");

    function deleteData() {
        var checked = grid.selectedDataItems();
        if(grid.selectedDataItems().length){
            kendo.ui.showConfirmDialog({
                title:$l('hap.tip.info'),
                message: $l('hap.tip.delete_confirm')
            }).done(function (event) {
                if (event.button == 'OK') {
                    $.each(checked,function(i,v){
                        grid.dataSource.remove(v)
                    })
                    grid.dataSource.sync();
                }
            })
        }
    }

</script>


<!-- 联动 -->
<script>
    var myData = [];
     function myDataToJson(data) {
        this.regionName = data.regionName;
        this.regionId = data.regionId;
        this.parentId = data.parentId;
    }


     $.ajax({
        url : '${base.contextPath}/demo/link/query',
        type : 'POST',
        contentType : "application/json;charset=utf-8",
        cache : false,
        dataType : 'json',
        async : false,
        success : function(data) {
            for (var i = 0 ; i < data.rows.length; i++) {
                myData.push(new myDataToJson(data.rows[i]));
            }
        }
    });

    $(document).ready(function(){
        //初始化控件
        firstDropDownList = $("#first").kendoDropDownList({
            optionLabel: "  --请选择省份--",
            dataTextField:"regionName",
            dataValueField:"regionId",
            dataSource:{
                data:myData
            },
            valuePrimitive: true,
            change:function(){
                var one_filter={field:"parentId", operator:"eq", value: parseInt(firstDropDownList.dataItem().regionId)};
                secondDropDownList.dataSource.filter(one_filter);
                secondDropDownList.select(-1);
                thirdDropDownList.select(-1);
            }
        }).data("kendoDropDownList");

        firstDropDownList.dataSource.filter({ field: "parentId", operator: "eq", value: 0 });

        //请选择城市
        secondDropDownList = $("#second").kendoDropDownList({
            optionLabel: "  --请选择城市--",
            dataTextField:"regionName",
            dataValueField:"regionId",
            dataSource:{
                data:myData
            },
            valuePrimitive: true,
            change:function(){
                //alert(secondDropDownList.dataItem().regionId);
                var two_filter={field:"parentId", operator:"eq", value: parseInt(secondDropDownList.dataItem().regionId)};
                thirdDropDownList.dataSource.filter(two_filter);
                thirdDropDownList.select(-1);
            }
        }).data("kendoDropDownList");

        var one_filter={field:"parentId", operator:"eq", value: parseInt(firstDropDownList.dataItem().regionId)};
        secondDropDownList.dataSource.filter(one_filter);

        //-请选择地区
        thirdDropDownList = $("#third").kendoDropDownList({
            optionLabel: "  --请选择地区--",
            dataTextField:"regionName",
            dataValueField:"regionId",
            dataSource:{
                data:myData
            },valuePrimitive: true
        }).data("kendoDropDownList");

        var two_filter={field:"parentId", operator:"eq", value: parseInt(secondDropDownList.dataItem().regionId)};
        thirdDropDownList.dataSource.filter(two_filter);

    });

</script>


<script>
    /* 删除
    $("#deleteBtn").click(function() {
        Hap.deleteGridSelection({grid:$("#grid")});
    });
    */
    Hap.autoResizeGrid($("#grid"));
</script>

</body>
</html>