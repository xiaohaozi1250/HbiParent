<#include "../include/header.html"/>
<body>
<script type="text/javascript">
    var viewModel = Hap.createGridViewModel("#grid");
</script>
<div id="content-container"
     style="display:flex;position:absolute;top: 15px;left: 15px;overflow: hidden;width: 100% ;height: 100%">
    <div class="col-sm-2" style="flex:0 0 16.7%;border:1px solid">
        <form class="form-horizontal" id="form1">
            <div id="page-content">
                <div style="padding:0px;height:100%">
                    <label class="pull-left"
                           style="padding-bottom:10px;margin-top:7px;margin-right: 5px;margin-left: -14px;">分发数据</label>
                    <div class="pull-left" id="toolbarMd-btn" style="padding-bottom:10px;width:10%">
                        <input id="distributeData" type="text" data-role="maskedtextbox"
                               style="float:left;width:150px;margin-right:5px;"
                               class="k-textbox" onblur="validateDistributeData()"/>
                    </div>
                    <div class="panel-body">
                        <div id="treeViewMd" style="clear: both;    margin-left: 16px"></div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div id="page-content-distribution" style="flex:1">
        <div style="border:1px solid;height:40%" id="query">
            <form class="form-horizontal" id="form2">
                <div class="panel-body">
                    <li style="font-size: 25px;padding-bottom: 13px;"><b>查询条件</b></li>
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label" style="margin-right: -20px;">数据编码</label>
                                <div class="col-md-8">
                                    <input name="itemCode" id="itemCode"
                                           data-role="maskedtextbox"
                                           type="text" style="width: 100%" data-bind="value:model.itemCode"
                                           class="k-textbox">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label" style="margin-right: -20px;">分发状态</label>
                                <div class="col-md-8">
                                    <input name="status" id="status"
                                           data-role="maskedtextbox"
                                           type="text" style="width: 100%" data-bind="value:model.status"
                                           class="k-textbox">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label" style="margin-right: -20px;">分发批次号</label>
                                <div class="col-md-8">
                                    <input name="batchNum" id="batchNum"
                                           data-role="maskedtextbox"
                                           type="text" style="width: 100%" data-bind="value:model.batchNum"
                                           class="k-textbox">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label" style="margin-right: -20px;">分发时间</label>
                                <div class="col-md-8">
                                    <input name="distributionDate" id="distributionDate"
                                           data-role="datepicker"
                                           type="text" style="width: 100%" data-bind="value:model.distributionDate"
                                           class="k-datepicker">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label" style="margin-right: -20px;">分发申请人</label>
                                <div class="col-md-8">
                                    <input name="name" id="name"
                                           data-role="maskedtextbox"
                                           type="text" style="width: 100%" data-bind="value:model.name"
                                           class="k-textbox">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label" style="margin-right: -20px;">组织</label>
                                <div class="col-md-8">
                                    <input name="organizationCode" id="organizationCode"
                                           data-role="maskedtextbox"
                                           type="text" style="width: 100%" data-bind="value:model.organizationCode"
                                           class="k-textbox">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label" style="margin-right: -20px;">创建时间从</label>
                                <div class="col-md-8">
                                    <input name="creationDateFrom" id="creationDateFrom"
                                           data-role="datetimepicker"
                                           type="text" style="width: 100%" data-bind="value:model.creationDateFrom"
                                           class="k-datetimepicker">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label" style="margin-right: -20px;">创建时间至</label>
                                <div class="col-md-8">
                                    <input name="creationDateTo" id="creationDateTo"
                                           data-role="datetimepicker"
                                           type="text" style="width: 100%" data-bind="value:model.creationDateTo"
                                           class="k-datetimepicker">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label" style="margin-right: -20px;">更新时间从</label>
                                <div class="col-md-8">
                                    <input name="lastUpdateDateFrom" id="lastUpdateDateFrom"
                                           data-role="datetimepicker"
                                           type="text" style="width: 100%" data-bind="value:model.lastUpdateDateFrom"
                                           class="k-datetimepicker">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label" style="margin-right: -20px;">更新时间至</label>
                                <div class="col-md-8">
                                    <input name="lastUpdateDateTo" id="lastUpdateDateTo"
                                           data-role="datetimepicker"
                                           type="text" style="width: 100%" data-bind="value:model.lastUpdateDateTo"
                                           class="k-datetimepicker">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <div class="col-md-8">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <div class="col-md-12">
                                    <span class="btn btn-primary"
                                          style="width: 75px;float:left;margin-right: 10px;margin-left: 60px;"
                                          data-bind="click:query" type="submit"><i class="fa fa-search"
                                                                                   style="margin-right:3px;"></i><@spring.message "hap.query"/></span>
                                    <span class="btn btn-default" type="button" data-bind="click:reset"
                                          style="width: 75px;"><i class="fa fa-undo"
                                                                  style="margin-right:3px;"></i><@spring.message "hap.reset"/></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <script>  kendo.bind($('#query'), viewModel);</script>
        </div>
        <div style="border:1px solid;height:60%;">
            <form class="form-horizontal" id="form3">
                <li style="float: left;margin-top: 6px;margin-left: 14px;font-size: 25px;padding-bottom: 18px;"><b>分发数据明细情况</b>
                </li>
                <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                    <label style="float: left;margin-top: 16px;margin-left: 46px;margin-right: 3px;">分发系统名称</label>
                    <input type="text" data-role="maskedtextbox"
                           style="float:left;width:152px;margin-left: 5px;margin-top: 10px;" placeholder=""
                           data-bind="value:model.itemCode" class="k-textbox">
                    <label style="float: left;margin-top: 16px;margin-left: 50px;margin-right: 3px;">分发接口名称</label>
                    <input type="text" data-role="maskedtextbox"
                           style="float:left;width:152px;margin-left:5px;margin-top: 10px;"
                           data-bind="value:model.itemCode" class="k-textbox">
                </div>
                <div class="pull-right" id="query-form" style="padding-bottom:10px;">
                    <span class="btn btn-primary" style="float:left;width: 75px;margin-right: 10px;margin-top: 10px;"
                          type="submit">执行</span>
                    <span class="btn btn-primary"
                          style="float:left;width: 75px;margin-right: 52px;margin-top: 10px;padding: 3px"
                          type="submit">查看明细</span>
                    <div style="clear:both"></div>
                </div>
                <div style="clear:both">
                    <div id="grid"></div>
                </div>
            </form>
        </div>
    </div>
</div>
</div>
<script type="text/javascript">
    baseUrl = "${base.contextPath}";
    var MdTreeDataSource = new kendo.data.HierarchicalDataSource({
        transport: {
            read: {
                url: baseUrl + "/mdTypeTree",
                type: "POST",
                dataType: "json",
                contentType: "application/json;charset=UTF-8"
            },
            parameterMap: function (options, type) {
                var mdType = $("#distributeData").val() || -1;
                console.log(mdType);
                return kendo.stringify(mdType);
            }
        },
        schema: {
            model: {
                id: "id",
                children: "items"
            }
        }
    });
    var treeViewMd = $("#treeViewMd").kendoTreeView({
        template: "<span style='font-weight:bold;'><i class='#= item.icon #'></i> #= item.text #</span>",
        dataValueField: "id",
        dataSource: MdTreeDataSource
    }).data("kendoTreeView");
    $("#distributeData").kendoLov({
        code: "DistributeData",
        contextPath: '${base.contextPath}',
        locale: 'zh_CN',
        textField: 'id',
        select: function (e) {
            MdTreeDataSource.read();
        }
    });
    function validateDistributeData() {
        if ($.isEmpty($("#distributeData").val())) {
            MdTreeDataSource.read();
        }
    }
    Hap.initEnterQuery('#query-form', viewModel.query);
    var BaseUrl = _basePath;
    dataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/hmdm/distribute/situation/query",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: BaseUrl + "/hmdm/distribute/situation/submit",
                type: "POST",
                contentType: "application/json"
            },
            destroy: {
                url: BaseUrl + "/hmdm/distribute/situation/remove",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/hmdm/distribute/situation/submit",
                type: "POST",
                contentType: "application/json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "headerId",
                fields: {distributionDate: {type: "date"}}
            }
        }
    });

    $("#grid").kendoGrid({
        dataSource: dataSource,
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable: 'multiple, rowbox',
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
            {
                field: "itemCode",
                title: '数据编码',
                width: 120
            },
            {
                field: "itemName",
                title: '数据名称',
                width: 120
            },
            {
                field: "organizationCode",
                title: '组织',
                width: 120
            },
            {
                field: "status",
                title: '分发状态',
                width: 120
            },
            {
                field: "batchNum",
                title: '分发批次号',
                width: 120
            },
            {
                field: "distributionDate",
                title: '分发日期',
                width: 120,
                format: "{0:yyyy-MM-dd}"
            },
            {
                field: "name",
                title: '分发申请人',
                width: 120
            },
        ],
        editable: true
    });
    /*    function expandMd() {
     $('#treeViewMd').data('kendoTreeView').expand(".k-item");
     }
     function collapseMd() {
     $('#treeViewMd').data('kendoTreeView').collapse(".k-item");
     }

     function refreshMd() {
     MdTreeDataSource.read();
     }*/

</script>
</body>
</html>